let plaques=[];async function loadPlaques(){try{console.log("ðŸ“‚ Caricamento placche dal backend...");const response=await fetch("./backend/data/plaques.json");if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`)}const data=await response.json();if(!Array.isArray(data)){throw new Error("Il file JSON non contiene un array valido")}plaques=data;console.log(`âœ… Caricate ${plaques.length} placche dal backend`);updateProgressDisplay();return plaques}catch(error){console.error("âŒ Errore nel caricamento delle placche:",error);console.log("ðŸ”„ Fallback alle placche hardcoded...");plaques=getFallbackPlaques();showToast("âš ï¸ Impossibile caricare i dati aggiornati. Usando dati di backup.");return plaques}}function getFallbackPlaques(){return[]}function updateProgressDisplay(){const totalPlaques=plaques.filter(p=>!p.isLastPlaque).length;const foundPlaques=userProgress.found.length;const counterProgress=document.getElementById("counter_progress");const ofCounterProgress=document.getElementById("of_counter_progress");if(counterProgress)counterProgress.textContent=foundPlaques;if(ofCounterProgress)ofCounterProgress.textContent=totalPlaques}const isMobile=window.innerWidth<768||/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);let map;let userProgress=JSON.parse(localStorage.getItem("progress"))||{found:[]};let currentPositionMarker;let routingControl;let userPosition;let isMapInitialized=false;let isRouteCalculating=false;let destinationMarker=null;let fallbackRouteLine=null;let currentDestination=null;function getCSSVariable(variableName){const rootStyles=getComputedStyle(document.documentElement);return rootStyles.getPropertyValue(variableName).trim()}function isTouch(event){return event.touches!==undefined||event instanceof TouchEvent}function vibrate(){if("vibrate"in navigator){navigator.vibrate(50)}}function resetButtons(){document.getElementById("startButton").innerHTML="Inizia l'Avventura";if(userProgress.found.length>0){document.getElementById("startButton").innerHTML="Continua l'Avventura"}}async function init(){console.log("ðŸš€ Inizializzazione applicazione...");await loadPlaques();map=undefined;isMapInitialized=false;currentPositionMarker=undefined;resetButtons();setupEventListeners();startWatchingPosition()}async function calculateRoute(){if(!userPosition){showToast("Attendi il posizionamento GPS...");return}if(!map||!isMapInitialized){console.log("Mappa non ancora inizializzata, impossibile calcolare il percorso");return}if(!routingControl){console.error("Routing control non definito, impossibile calcolare il percorso");return}const nextPlaque=plaques.find(p=>!userProgress.found.includes(p.id)&&isUnlocked(p.id));if(!nextPlaque){showToast("Hai giÃ  trovato tutte le targhe!");return}try{console.log("Calcolo percorso da",userPosition.coords.latitude,userPosition.coords.longitude,"a",nextPlaque.lat,nextPlaque.lng);showLoadingIndicator();if(map.hasLayer(routingControl)){map.removeControl(routingControl)}routingControl=L.Routing.control({waypoints:[L.latLng(userPosition.coords.latitude,userPosition.coords.longitude),L.latLng(nextPlaque.lat,nextPlaque.lng)],show:false,addWaypoints:false,draggableWaypoints:false,fitSelectedRoutes:"smart",createMarker:function(){return null},lineOptions:{styles:[{color:getCSSVariable("--secondary-color"),opacity:.8,weight:isMobile?4:5}]},router:L.Routing.osrmv1({serviceUrl:"https://router.project-osrm.org/route/v1",profile:"walking"}),routeWhileDragging:!isMobile}).addTo(map);routingControl.on("routesfound",function(e){console.log("Percorso trovato:",e.routes);setTimeout(()=>{map.invalidateSize();if(e.routes&&e.routes.length>0){try{if(e.routes[0].bounds){map.fitBounds(e.routes[0].bounds,{padding:[50,50],maxZoom:isMobile?15:18})}}catch(error){console.error("Errore nell'adattamento della mappa al percorso:",error)}}if(!destinationMarker){const destIcon=L.icon({iconUrl:"./target-marker.png",iconSize:[32,32],iconAnchor:[16,32]});try{destinationMarker=L.marker([nextPlaque.lat,nextPlaque.lng],{icon:destIcon}).addTo(map);const isFound=userProgress.found.includes(nextPlaque.id);destinationMarker.bindPopup(`<b>${nextPlaque.title||"Targhetta"}</b><br>Distanza: ${(e.routes[0].summary.totalDistance/1e3).toFixed(1)} km`).on("click",()=>showPlaque(nextPlaque,nextPlaque.id,isFound));destinationMarker.openPopup()}catch(markerError){console.error("Errore nella creazione del marker di destinazione:",markerError);destinationMarker=L.marker([nextPlaque.lat,nextPlaque.lng]).addTo(map)}}else{destinationMarker.setLatLng([nextPlaque.lat,nextPlaque.lng])}const routeElements=document.querySelectorAll(".leaflet-overlay-pane path");routeElements.forEach(path=>{path.style.display="block";path.style.visibility="visible";path.style.opacity="0.8"});hideLoadingIndicator()},500)});routingControl.on("routingerror",function(e){console.error("Errore di routing:",e.error);hideLoadingIndicator();showToast("Errore nel calcolo del percorso. Distanza troppo grande o servizio non disponibile.");createFallbackRoute([userPosition.coords.latitude,userPosition.coords.longitude],[nextPlaque.lat,nextPlaque.lng])});setTimeout(()=>{if(document.querySelector(".loading-indicator.active")){hideLoadingIndicator();showToast("Calcolo del percorso in corso, potrebbe richiedere un po' di tempo...")}},5e3)}catch(error){console.error("Errore nel calcolo del percorso:",error);hideLoadingIndicator();showToast("Errore nel calcolo del percorso. Riprova piÃ¹ tardi.");createFallbackRoute([userPosition.coords.latitude,userPosition.coords.longitude],[nextPlaque.lat,nextPlaque.lng])}}function createFallbackRoute(start,end){console.log("Creazione percorso fallback semplificato");try{if(fallbackRouteLine&&map.hasLayer(fallbackRouteLine)){map.removeLayer(fallbackRouteLine)}fallbackRouteLine=L.polyline([start,end],{color:getCSSVariable("--secondary-color"),opacity:.8,weight:isMobile?4:5,dashArray:"5, 10"}).addTo(map);map.fitBounds(fallbackRouteLine.getBounds(),{padding:[50,50]});const nextPlaque=plaques.find(p=>!userProgress.found.includes(p.id)&&isUnlocked(p.id));if(nextPlaque&&!destinationMarker){destinationMarker=L.marker([nextPlaque.lat,nextPlaque.lng]).addTo(map);const distanceKm=calculateDistance(start,end);destinationMarker.bindPopup(`<b>${nextPlaque.title||"Targhetta"}</b><br>Distanza in linea d'aria: ${distanceKm.toFixed(1)} km`)}}catch(error){console.error("Errore nella creazione del percorso fallback:",error)}}function calculateDistance(point1,point2){const R=6371;const dLat=(point2[0]-point1[0])*Math.PI/180;const dLon=(point2[1]-point1[1])*Math.PI/180;const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(point1[0]*Math.PI/180)*Math.cos(point2[0]*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c}function cleanupMap(){if(map){if(routingControl&&map.hasLayer(routingControl)){map.removeControl(routingControl)}if(currentPositionMarker&&map.hasLayer(currentPositionMarker)){map.removeLayer(currentPositionMarker)}if(destinationMarker&&map.hasLayer(destinationMarker)){map.removeLayer(destinationMarker)}if(fallbackRouteLine&&map.hasLayer(fallbackRouteLine)){map.removeLayer(fallbackRouteLine)}routingControl=null;currentPositionMarker=null;destinationMarker=null;fallbackRouteLine=null}}function returnToMainMenu(){cleanupMap();document.getElementById("map").style.display="none";document.querySelector(".progress-container").style.display="none";document.getElementById("locationScreen").classList.remove("active");document.getElementById("mainMenu").classList.add("active")}function showLoadingIndicator(){let loadingIndicator=document.getElementById("map-loading-indicator");if(!loadingIndicator){loadingIndicator=document.createElement("div");loadingIndicator.id="map-loading-indicator";loadingIndicator.className="loading-indicator";loadingIndicator.innerHTML='<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.8); padding: 15px; border-radius: 5px; text-align: center;">Calcolo percorso in corso...</div>';const mapContainer=document.getElementById("map");if(mapContainer){mapContainer.style.position="relative";mapContainer.appendChild(loadingIndicator)}else{document.body.appendChild(loadingIndicator)}}else{loadingIndicator.style.display="block"}}function hideLoadingIndicator(){const loadingIndicator=document.getElementById("map-loading-indicator");if(loadingIndicator){loadingIndicator.style.display="none"}}async function initMap(){if(isMapInitialized&&map){try{map.invalidateSize();if(userPosition){updatePositionMarker(userPosition)}}catch(error){console.error("Errore durante l'aggiornamento della mappa:",error)}return}const mapContainer=document.getElementById("map");if(mapContainer){mapContainer.style.visibility="hidden"}try{map=L.map("map",{zoomControl:!isMobile,attributionControl:true}).setView([40.7527295,14.6464048],isMobile?13:14);const tileLayer=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?v=1.0.18",{updateWhenIdle:isMobile,updateWhenZooming:!isMobile,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);if(isMobile){L.control.zoom({position:"bottomright"}).addTo(map)}if(typeof L.Routing==="undefined"||typeof L.Routing.control==="undefined"){console.error("L.Routing o L.Routing.control non sono definiti. Verificare che leaflet-routing-machine sia caricato correttamente.");showToast("Errore nel caricamento del sistema di routing. Ricarica la pagina.",5e3);isMapInitialized=true;if(mapContainer){mapContainer.style.visibility="visible"}return}try{console.log("Inizializzazione routing control...");const routingConfig={waypoints:[],show:false,addWaypoints:false,draggableWaypoints:false,fitSelectedRoutes:true,createMarker:()=>null,lineOptions:{styles:[{color:getCSSVariable("--secondary-color"),opacity:.8,weight:isMobile?4:5}]},router:L.Routing.osrmv1({serviceUrl:"https://router.project-osrm.org/route/v1",profile:"walking",timeout:30*1e3})};if(!isMobile){routingConfig.routeWhileDragging=true;routingConfig.showAlternatives=false;routingConfig.useZoomParameter=true}console.log("Configurazione routing:",routingConfig);routingControl=L.Routing.control(routingConfig).addTo(map);if(routingControl){console.log("Routing control inizializzato con successo");if(userPosition){setTimeout(()=>calculateRoute(),500)}}else{console.error("Routing control non Ã¨ stato creato correttamente")}}catch(routingError){console.error("Errore nell'inizializzazione del routing control:",routingError);console.error("Stack trace:",routingError.stack);tryToLoadRoutingDynamically()}isMapInitialized=true;if(isMobile){optimizeTouchInteraction()}if(userPosition){setTimeout(()=>updatePositionMarker(userPosition),300)}if(mapContainer){mapContainer.style.visibility="visible"}setTimeout(()=>{if(map)map.invalidateSize()},100);return map}catch(error){console.error("Errore nell'inizializzazione della mappa:",error);console.error("Stack trace:",error.stack);if(mapContainer){mapContainer.style.visibility="visible"}throw error}}function tryToLoadRoutingDynamically(){console.log("Tentativo di caricamento dinamico del modulo di routing...");const stylesheetExists=Array.from(document.styleSheets).some(sheet=>sheet.href&&sheet.href.includes("leaflet-routing-machine"));const scriptExists=Array.from(document.scripts).some(script=>script.src&&script.src.includes("leaflet-routing-machine"));if(!stylesheetExists){const link=document.createElement("link");link.rel="stylesheet";link.href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css";document.head.appendChild(link);console.log("Foglio di stile routing caricato dinamicamente")}if(!scriptExists){const script=document.createElement("script");script.src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js";script.onload=function(){console.log("Script routing caricato dinamicamente. Tentativo di reinizializzazione...");setTimeout(()=>{if(typeof L.Routing!=="undefined"&&typeof L.Routing.control!=="undefined"){console.log("Routing disponibile dopo caricamento dinamico");isMapInitialized=false;initMap().then(()=>{if(userPosition){calculateRoute()}})}else{console.error("Impossibile caricare il modulo di routing anche dopo caricamento dinamico")}},1e3)};script.onerror=function(){console.error("Errore nel caricamento dinamico dello script di routing")};document.body.appendChild(script);console.log("Script routing caricato dinamicamente")}}function checkGpsIconExists(){return new Promise((resolve,reject)=>{const img=new Image;img.onload=()=>resolve(true);img.onerror=()=>resolve(false);img.src="./gps.png?v=1.0.27"})}function optimizeTouchInteraction(){if(!map)return;const mapElement=document.getElementById("map");if(mapElement){let touchStartTime=0;mapElement.addEventListener("touchstart",e=>{const now=(new Date).getTime();if(now-touchStartTime<300&&e.touches.length===1){e.preventDefault()}touchStartTime=now},{passive:false})}let lastMoveTime=0;map.on("move",function(){const now=Date.now();if(now-lastMoveTime>100){lastMoveTime=now}})}function setupEventListeners(){document.querySelector(".overlay").addEventListener("click",closeModal);document.getElementById("answerForm").addEventListener("submit",handleFormSubmit);window.addEventListener("resize",handleWindowResize)}function handleWindowResize(){if(map&&isMapInitialized){setTimeout(()=>{map.invalidateSize()},200)}}function checkLocationPermissions(){return new Promise((resolve,reject)=>{if(!navigator.permissions||!navigator.permissions.query){console.log("API Permissions non supportata, passiamo direttamente alla richiesta");resolve("unknown");return}navigator.permissions.query({name:"geolocation"}).then(permissionStatus=>{console.log("Stato attuale dei permessi di geolocalizzazione:",permissionStatus.state);resolve(permissionStatus.state)}).catch(error=>{console.warn("Impossibile verificare i permessi:",error);resolve("unknown")})})}function forceLocationPermissionRequest(){console.log("Forzo la richiesta dei permessi di geolocalizzazione...");if(!navigator.geolocation){showToast("Il tuo browser non supporta la geolocalizzazione. Prova ad utilizzare un browser piÃ¹ recente.",5e3);return Promise.reject("Geolocalizzazione non supportata")}showToast("Richiesta accesso alla posizione...",2e3);const options={enableHighAccuracy:true,timeout:1e4,maximumAge:0};return new Promise((resolve,reject)=>{navigator.geolocation.getCurrentPosition(position=>{console.log("Permessi concessi e posizione ottenuta:",position);userPosition=position;if(map&&isMapInitialized){updatePositionMarker(position);if(currentDestination){calculateRoute()}}showToast("Posizione GPS rilevata!",2e3);startPositionTracking();resolve(position)},error=>{console.error("Errore nell'ottenere la posizione:",error);let errorMessage="";switch(error.code){case error.PERMISSION_DENIED:errorMessage="Permesso di geolocalizzazione negato. Per usare questa funzione, devi consentire l'accesso alla posizione.";break;case error.POSITION_UNAVAILABLE:errorMessage="Informazioni sulla posizione non disponibili. Verifica che il GPS sia attivo.";break;case error.TIMEOUT:errorMessage="Richiesta di posizione scaduta. Verifica connessione e GPS.";break;default:errorMessage="Errore sconosciuto nel rilevamento della posizione.";break}showToast(errorMessage,5e3);reject(error)},options)})}function requestLocationPermissionIfNeeded(){console.log("Verifica dei permessi di geolocalizzazione...");if(!navigator.geolocation){showToast("Il tuo browser non supporta la geolocalizzazione. Prova ad utilizzare un browser piÃ¹ recente.",5e3);return Promise.reject("Geolocalizzazione non supportata")}return checkLocationPermissions().then(permissionState=>{if(permissionState==="granted"){console.log("Permessi giÃ  concessi, recupero posizione...");return getCurrentPosition()}else{console.log("Permessi non ancora concessi o negati, forzo la richiesta...");return forceLocationPermissionRequest()}}).catch(error=>{console.error("Errore nella verifica dei permessi:",error);return Promise.reject(error)})}function getCurrentPosition(){const options={enableHighAccuracy:true,timeout:15e3+retryCount*5e3,maximumAge:retryCount>0?6e4:0};console.log(`Tentativo ${retryCount+1}/${maxRetries+1} di ottenere la posizione GPS...`);return new Promise((resolve,reject)=>{navigator.geolocation.getCurrentPosition(position=>{console.log("Posizione ottenuta:",position);userPosition=position;if(map&&isMapInitialized){updatePositionMarker(position);if(currentDestination){calculateRoute()}}showToast("Posizione GPS rilevata!",2e3);startPositionTracking();resolve(position)},error=>{console.error("Errore nell'ottenere la posizione:",error);let errorMessage="";switch(error.code){case error.PERMISSION_DENIED:errorMessage="Permesso di geolocalizzazione negato. Abilitalo nelle impostazioni del browser per utilizzare questa funzionalitÃ .";break;case error.POSITION_UNAVAILABLE:errorMessage="Informazioni sulla posizione non disponibili. Verifica che il GPS sia attivo.";break;case error.TIMEOUT:errorMessage="Richiesta di posizione scaduta. Verifica la connessione e il GPS.";break;default:errorMessage="Errore sconosciuto nel rilevamento della posizione.";break}showToast(errorMessage,5e3);reject(error)},options)})}function startPositionTracking(highAccuracy=true){if(positionWatchId!==null){stopPositionTracking()}const options={enableHighAccuracy:highAccuracy,timeout:highAccuracy?15e3:3e4,maximumAge:highAccuracy?0:6e4};positionWatchId=navigator.geolocation.watchPosition(position=>{userPosition=position;if(map&&isMapInitialized){updatePositionMarker(position);if(currentDestination&&(!lastRouteUpdateTime||Date.now()-lastRouteUpdateTime>1e4)){lastRouteUpdateTime=Date.now();calculateRoute()}}},error=>{console.error("Errore nel monitoraggio della posizione:",error);if(error.code===error.TIMEOUT&&highAccuracy){console.log("Passaggio al monitoraggio con bassa precisione...");stopPositionTracking();startPositionTracking(false);return}if(error.code===error.PERMISSION_DENIED){stopPositionTracking()}},options);console.log(`Monitoraggio della posizione avviato (precisione: ${highAccuracy?"alta":"bassa"}), ID: ${positionWatchId}`)}function stopPositionTracking(){if(positionWatchId!==null){navigator.geolocation.clearWatch(positionWatchId);console.log("Monitoraggio della posizione fermato, ID:",positionWatchId);positionWatchId=null}}function startWatchingPosition(){navigator.geolocation.watchPosition(position=>{userPosition=position;if(map&&isMapInitialized){updatePositionMarker(position);calculateRoute()}},error=>showToast(`Errore GPS: ${error.message}`),{enableHighAccuracy:true})}function updatePositionMarker(position){if(!map||!isMapInitialized){console.log("Mappa non ancora inizializzata, impossibile aggiungere il marker GPS");return}const{latitude,longitude}=position.coords;if(isNaN(latitude)||isNaN(longitude)){console.error("Coordinate GPS non valide:",latitude,longitude);return}console.log("Aggiornamento posizione GPS:",latitude,longitude);if(!currentPositionMarker){const iconSize=isMobile?[24,24]:[32,32];const iconAnchor=isMobile?[12,24]:[16,32];const iconUrl="./gps.png?v=1.0.27";console.log("Creazione nuovo marker con icona:",iconUrl);try{const gpsIcon=L.icon({iconUrl:iconUrl,iconSize:iconSize,iconAnchor:iconAnchor});currentPositionMarker=L.marker([latitude,longitude],{icon:gpsIcon}).addTo(map);currentPositionMarker.setOpacity(1);currentPositionMarker.bindPopup(`Posizione GPS`);console.log("Marker GPS creato e aggiunto alla mappa")}catch(error){console.error("Errore nella creazione del marker:",error);try{currentPositionMarker=L.marker([latitude,longitude]).addTo(map);console.log("Creato marker fallback senza icona personalizzata")}catch(fallbackError){console.error("Errore anche nel fallback:",fallbackError)}}}else{try{currentPositionMarker.setLatLng([latitude,longitude]);console.log("Posizione marker GPS aggiornata")}catch(error){console.error("Errore nell'aggiornamento della posizione del marker:",error)}}if(map){try{map.invalidateSize()}catch(error){console.error("Errore nell'invalidazione delle dimensioni della mappa:",error)}}}function updateMap(){if(map){map.eachLayer(layer=>{if(layer instanceof L.Marker&&layer!==currentPositionMarker)map.removeLayer(layer)});plaques.forEach(plaque=>{if(isUnlocked(plaque.id)){const isFound=userProgress.found.includes(plaque.id);const iconSize=isMobile?[24,24]:[32,32];const iconAnchor=isMobile?[12,24]:[16,32];currentDestination=L.latLng(plaque.lat,plaque.lng);L.marker([plaque.lat,plaque.lng],{icon:L.icon({iconUrl:isFound?"./447147.png?v=1.0.27":"./684908.png?v=1.0.27",iconSize:iconSize,iconAnchor:iconAnchor})}).bindPopup(plaque.title).on("click",()=>showPlaque(plaque,plaque.id,isFound)).addTo(map)}})}}function isUnlocked(id){return userProgress.found.includes(id)||userProgress.found.length===0&&id===1||id===userProgress.found[userProgress.found.length-1]+1}function showPlaque(plaque,id,isFound=false){returnTo360(id,isFound)}function handleFormSubmit(e){e.preventDefault();const answers=Array.from(e.target.elements).filter(el=>el.tagName==="INPUT").map(input=>input.value.toLowerCase().trim());const plaque=plaques.find(p=>p.id===userProgress.found.length+1);if(userPosition){const valid=validateAnswer(plaque,answers,userPosition);if(valid){userProgress.found.push(plaque.id);saveProgress();updateMap();closeModal();showNextLocation()}showToast(valid?"Corretto! Targa sbloccata!":"Risposta errata o posizione non corretta")}}function validateAnswer(plaque,answers,position){console.log("Validazione risposta:",plaque,answers,position);const distance=haversineDistance(position.coords.latitude,position.coords.longitude,plaque.lat,plaque.lng);const correctWords=plaque.missingWords.map(w=>w.toLowerCase()).every((w,i)=>w===answers[i]);return distance<=plaque.radius&&correctWords}function haversineDistance(lat1,lon1,lat2,lon2){return 10}function closeModal(){document.querySelector(".modal").classList.remove("active");document.querySelector(".overlay").classList.remove("active")}function saveProgress(){localStorage.setItem("progress",JSON.stringify(userProgress));updateStatus()}function resetGame(){if(confirm("Sei sicuro di voler resettare il gioco? Tutti i progressi andranno persi!")){if(routingControl){map.removeControl(routingControl);routingControl=null}localStorage.removeItem("progress");localStorage.removeItem("tourCompletato");userProgress={found:[]};updateMap();document.getElementById("counter").textContent=0;returnToHome()}updateStatus()}function showToast(message,duration=3e3){const toast=document.querySelector(".toast");toast.textContent=message;toast.style.display="block";setTimeout(()=>toast.style.display="none",duration)}init();function startGame(){document.getElementById("welcomeCover").classList.add("hidden");showNextLocation()}function showInstructions(){document.getElementById("instructionsModal").classList.add("active")}function closeInstructions(){document.getElementById("instructionsModal").classList.remove("active")}function showNextLocation(){document.getElementById("map").style.display="none";document.querySelector(".progress-container").style.display="none";const nextPlaqueId=userProgress.found.length+1;const nextPlaque=plaques.find(p=>p.id===nextPlaqueId);if(nextPlaque&&nextPlaque.locationImage){display360InLocation(nextPlaque,nextPlaqueId,false,nextPlaque.locationBlurMaskImage)}document.getElementById("locationTitle").textContent=nextPlaque.locationTitle;document.getElementById("locationDescription").innerHTML=nextPlaque.locationDescription;document.getElementById("locationScreen").classList.add("active")}function startSearch(){document.getElementById("locationScreen").classList.remove("active");showLoadingIndicator();document.getElementById("map").style.display="block";document.querySelector(".progress-container").style.display="flex";initMap().then(()=>{console.log("Mappa inizializzata");if(map)map.invalidateSize();updateMap();addPermissionRequestButton();return requestLocationPermissionIfNeeded().then(position=>{console.log("Posizione GPS ottenuta");hidePermissionRequestButton();if(currentDestination){calculateRoute()}}).catch(error=>{console.warn("Impossibile ottenere la posizione GPS:",error);showPermissionRequestButton();if(error&&error.code===1){showToast("Per utilizzare la navigazione, abilita l'accesso alla posizione.",5e3)}})}).catch(error=>{console.error("Errore nell'inizializzazione della mappa:",error);showToast("Errore nel caricamento della mappa. Riprova piÃ¹ tardi.",5e3)}).finally(()=>{hideLoadingIndicator()})}function addPermissionRequestButton(){if(document.getElementById("permissionRequestButton")){return}const button=document.createElement("button");button.id="permissionRequestButton";button.className="permission-button";button.innerHTML='<i class="fas fa-location-arrow"></i> Attiva posizione';button.style.position="absolute";button.style.bottom="80px";button.style.right="20px";button.style.zIndex="1000";button.style.backgroundColor="#007bff";button.style.color="white";button.style.border="none";button.style.borderRadius="4px";button.style.padding="10px 15px";button.style.fontWeight="bold";button.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)";button.style.display="flex";button.style.alignItems="center";button.style.justifyContent="center";button.style.display="none";button.addEventListener("click",()=>{forceLocationPermissionRequest().then(()=>{button.style.display="none"}).catch(error=>{console.warn("Richiesta permessi fallita:",error)})});const mapElement=document.getElementById("map");if(mapElement){mapElement.appendChild(button)}}function showPermissionRequestButton(){const button=document.getElementById("permissionRequestButton");if(button){button.style.display="flex"}else{addPermissionRequestButton();showPermissionRequestButton()}}function hidePermissionRequestButton(){const button=document.getElementById("permissionRequestButton");if(button){button.style.display="none"}}function returnToHome(){document.getElementById("locationScreen").classList.remove("active");document.getElementById("welcomeCover").classList.remove("hidden");document.getElementById("map").style.display="none";document.querySelector(".progress-container").style.display="none";resetButtons()}function getOptimizedImageForDevice(plaque,isHighRes=false){if(isMobile&&!isHighRes){return plaque.locationImageLowRes||plaque.locationImage}return"./backend/"+plaque.locationImage}function display360InLocation(plaque,id=0,isFound=false,blurMaskImage=null,blurIntensity=1.95){const container=document.getElementById("locationImage");container.innerHTML="";const isTouchDevice="ontouchstart"in window||navigator.maxTouchPoints>0;if(isTouchDevice&&!isFound){const touchIndicator=document.createElement("div");touchIndicator.className="touch-indicator";touchIndicator.innerHTML=`
            <div class="touch-hint">
                <div class="touch-icon">ðŸ‘†</div>
                <span>Tocca le aree evidenziate per interagire</span>
                <div class="touch-swipe-hint">Scorri per esplorare</div>
            </div>
        `;container.appendChild(touchIndicator);setTimeout(()=>{touchIndicator.style.opacity="0";setTimeout(()=>touchIndicator.style.display="none",1e3)},4e3)}if(container.scene){container.scene.dispose()}const scene=new THREE.Scene;const camera=new THREE.PerspectiveCamera(75,container.clientWidth/container.clientHeight,.1,1e3);const renderer=new THREE.WebGLRenderer({alpha:true,antialias:!isMobile,powerPreference:isMobile?"low-power":"high-performance"});renderer.setSize(container.clientWidth,container.clientHeight);container.appendChild(renderer.domElement);camera.position.z=.1;const controls=new THREE.OrbitControls(camera,renderer.domElement);controls.autoRotate=false;if(isMobile){controls.rotateSpeed=.5;controls.enableDamping=true;controls.dampingFactor=.1}let autoRotationEnabled=true;const autoRotationSpeed=.005;let rotationVelocity=0;const maxRotationVelocity=.3;const inertiaFactor=.95;let lastDeltaX=0;let isInertiaActive=false;let userInteracting=false;controls.enableZoom=true;controls.zoomSpeed=isMobile?.5:1;controls.enablePan=false;controls.minPolarAngle=Math.PI*.1;controls.maxPolarAngle=Math.PI*.9;let isDragging=false;const setCursor=type=>{container.style.cursor=type};const segments=isMobile?40:60;const geometry=new THREE.SphereGeometry(500,segments,40);geometry.scale(-1,1,1);const textureLoader=new THREE.TextureLoader;const maskLoader=new THREE.TextureLoader;let panoramaMaterial;let maskTexture;let blurMaskTexture=null;let maskMaterial=undefined;const COLOR_MAGENTA=new THREE.Color(16711935);const COLOR_GREEN=new THREE.Color(65280);const loadPromises=[];const interactiveMaskPromise=new Promise((resolve,reject)=>{maskLoader.load("./backend/"+plaque.locationMaskImage,texture=>resolve(texture),undefined,error=>reject(error))});loadPromises.push(interactiveMaskPromise);let blurMaskPromise=Promise.resolve(null);if(blurMaskImage){blurMaskPromise=new Promise((resolve,reject)=>{maskLoader.load("./backend/"+blurMaskImage,texture=>resolve(texture),undefined,error=>reject(error))});loadPromises.push(blurMaskPromise)}const lowResPromise=new Promise((resolve,reject)=>{textureLoader.load(getOptimizedImageForDevice(plaque,false),texture=>resolve(texture),undefined,error=>reject(error))});loadPromises.push(lowResPromise);Promise.all(loadPromises).then(textures=>{maskTexture=textures[0];let lowResTexture;if(blurMaskImage){blurMaskTexture=textures[1];lowResTexture=textures[2]}else{lowResTexture=textures[1]}panoramaMaterial=new THREE.ShaderMaterial({uniforms:{panoramaTexture:{value:lowResTexture},blurMaskTexture:{value:blurMaskTexture},useBlurMask:{value:blurMaskTexture!==null},blurStrength:{value:isMobile?blurIntensity*.7:blurIntensity},textureSize:{value:new THREE.Vector2(lowResTexture.image.width,lowResTexture.image.height)}},vertexShader:`
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                uniform sampler2D panoramaTexture;
                uniform sampler2D blurMaskTexture;
                uniform bool useBlurMask;
                uniform float blurStrength;
                uniform vec2 textureSize;
                varying vec2 vUv;
                
                vec4 applyBlur(sampler2D tex, vec2 uv, float strength) {
                    // Calcola dimensione pixel per offsets precisi
                    vec2 texelSize = 1.0 / textureSize;
                    
                    // Box blur semplice
                    vec4 result = vec4(0.0);
                    float totalWeight = 0.0;
                    
                    // Dimensione del kernel proporzionale all'intensitÃ 
                    float radius = strength * 4.0;
                    
                    for (float x = -radius; x <= radius; x += 1.0) {
                        for (float y = -radius; y <= radius; y += 1.0) {
                            vec2 offset = vec2(x, y) * texelSize;
                            result += texture2D(tex, uv + offset);
                            totalWeight += 1.0;
                        }
                    }
                    
                    return result / totalWeight;
                }
                
                void main() {
                    // Leggi il colore originale
                    vec4 originalColor = texture2D(panoramaTexture, vUv);
                    
                    if (useBlurMask) {
                        // Leggi il valore della maschera di blur
                        vec4 maskColor = texture2D(blurMaskTexture, vUv);
                        
                        // Se siamo in un'area bianca della maschera di blur
                        if (maskColor.r > 0.5) {
                            // Applica blur con intensitÃ  proporzionale alla maschera
                            float blurAmount = maskColor.r * blurStrength;
                            gl_FragColor = applyBlur(panoramaTexture, vUv, blurAmount);
                        } else {
                            // Nessun blur, mostra il colore originale
                            gl_FragColor = originalColor;
                        }
                    } else {
                        // Nessuna maschera di blur, mostra il colore originale ovunque
                        gl_FragColor = originalColor;
                    }
                }
            `});const sphere=new THREE.Mesh(geometry,panoramaMaterial);scene.add(sphere);textureLoader.load(getOptimizedImageForDevice(plaque,true),highRes=>{panoramaMaterial.uniforms.panoramaTexture.value=highRes;panoramaMaterial.uniforms.textureSize.value.set(highRes.image.width,highRes.image.height);panoramaMaterial.needsUpdate=true});setupInteractiveMask(maskTexture)}).catch(error=>{console.error("Errore durante il caricamento delle texture:",error)});function setupInteractiveMask(interactiveMaskTexture){const maskImage=document.createElement("canvas");const maskImageContext=maskImage.getContext("2d");maskImage.width=interactiveMaskTexture.image.width;maskImage.height=interactiveMaskTexture.image.height;maskImageContext.drawImage(interactiveMaskTexture.image,0,0);maskMaterial=new THREE.ShaderMaterial({uniforms:{maskTexture:{value:interactiveMaskTexture},time:{value:0},color:{value:COLOR_MAGENTA.clone()},isMouseOver:{value:0}},transparent:true,vertexShader:`
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                uniform sampler2D maskTexture;
                uniform float time;
                uniform vec3 color;
                uniform float isMouseOver;
                varying vec2 vUv;

                void main() {
                    vec4 maskValue = texture2D(maskTexture, vUv);
                    
                    if (maskValue.r > 0.2) {
                        if (isMouseOver > 0.2) {
                            gl_FragColor = vec4(color, 0.5);
                        } else {
                            float alpha = 0.2 + 0.2 * sin(time * 2.0);
                            gl_FragColor = vec4(color, alpha);
                        }
                    } else {
                        discard;
                    }
                }
            `});const maskSegments=isMobile?40:60;const maskGeometry=new THREE.SphereGeometry(490,maskSegments,40);maskGeometry.scale(-1,1,1);const mask=new THREE.Mesh(maskGeometry,maskMaterial);if(!isFound){scene.add(mask)}const raycaster=new THREE.Raycaster;const mouse=new THREE.Vector2;const handleInteraction=(event,isClick=false)=>{event.stopPropagation();if(event.cancelable){event.preventDefault()}if(isDragging)return;if(!isFound){const rect=container.getBoundingClientRect();let clientX,clientY;if(event.type.startsWith("touch")){if(event.changedTouches&&event.changedTouches.length>0){if(event.cancelable){event.preventDefault()}clientX=event.changedTouches[0].clientX;clientY=event.changedTouches[0].clientY}else{console.warn("Evento touch senza changedTouches validi");return}}else if(event.touches){clientX=event.touches[0].clientX;clientY=event.touches[0].clientY}else{clientX=event.clientX;clientY=event.clientY}mouse.x=(clientX-rect.left)/container.clientWidth*2-1;mouse.y=-((clientY-rect.top)/container.clientHeight)*2+1;raycaster.setFromCamera(mouse,camera);const intersects=raycaster.intersectObject(mask);if(intersects.length>0){const uv=intersects[0].uv;if(uv){const x=Math.floor(uv.x*maskImage.width);const y=Math.floor((1-uv.y)*maskImage.height);const pixel=maskImageContext.getImageData(x,y,1,1).data;if(pixel[0]>128&&pixel[1]>128&&pixel[2]>128){maskMaterial.uniforms.color.value=COLOR_GREEN.clone();maskMaterial.uniforms.isMouseOver.value=1;container.style.cursor="pointer";if(isClick){if(event.cancelable){event.preventDefault()}event.stopPropagation();if(isTouch(event)){vibrate()}document.getElementById("plaqueImage").src="./backend/"+plaque.image;document.getElementById("inputsContainer").innerHTML=plaque.missingWords.map((word,idx)=>`<input type="text" placeholder="parola n. ${idx+1}" required>`).join("");document.querySelector(".modal").classList.add("active");document.querySelector(".overlay").classList.add("active")}return}}}maskMaterial.uniforms.color.value=COLOR_MAGENTA.clone();maskMaterial.uniforms.isMouseOver.value=0;container.style.cursor="move"}};if(isMobile){container.addEventListener("touchmove",e=>{if(handleInteraction(e)){e.stopPropagation();if(e.cancelable)e.preventDefault()}});container.addEventListener("touchend",e=>{if(handleInteraction(e,true)){e.stopPropagation();if(e.cancelable)e.preventDefault()}})}else{container.addEventListener("mousemove",e=>handleInteraction(e));container.addEventListener("click",e=>{if(handleInteraction(e,true)){e.stopPropagation();e.preventDefault()}})}}const clock=new THREE.Clock;let lon=0,lat=0,phi=0,theta=0;let previousMouseX=0,previousMouseY=0;function animate(){requestAnimationFrame(animate);if(!isMobile||!userInteracting){controls.update()}if(autoRotationEnabled&&!userInteracting&&!isInertiaActive){scene.rotation.y+=autoRotationSpeed}else if(isInertiaActive){scene.rotation.y+=rotationVelocity;rotationVelocity*=inertiaFactor;if(Math.abs(rotationVelocity)<1e-4){isInertiaActive=false}}if(maskMaterial){maskMaterial.uniforms.time.value=clock.getElapsedTime()}phi=THREE.MathUtils.degToRad(90-lat);theta=THREE.MathUtils.degToRad(lon);camera.lookAt(500*Math.sin(phi)*Math.cos(theta),500*Math.cos(phi),500*Math.sin(phi)*Math.sin(theta));renderer.render(scene,camera)}animate();container.addEventListener("wheel",event=>{event.preventDefault();const zoomFactor=isMobile?.03:.05;camera.fov+=event.deltaY*zoomFactor;camera.fov=Math.max(10,Math.min(75,camera.fov));camera.updateProjectionMatrix()});container.addEventListener("mouseenter",()=>{if(!isDragging)setCursor("move")});container.addEventListener("mousedown",event=>{isDragging=true;autoRotationEnabled=false;userInteracting=true;setCursor("grabbing");previousMouseX=event.clientX;previousMouseY=event.clientY});container.addEventListener("mousemove",event=>{if(isDragging){const deltaX=event.clientX-previousMouseX;const deltaY=event.clientY-previousMouseY;lastDeltaX=deltaX;lon-=deltaX*.1;lat+=deltaY*.1;lat=Math.max(-85,Math.min(85,lat));previousMouseX=event.clientX;previousMouseY=event.clientY;setCursor("grabbing")}});container.addEventListener("mouseup",()=>{userInteracting=false;isDragging=false;rotationVelocity=-lastDeltaX*5e-4;rotationVelocity=Math.max(-maxRotationVelocity,Math.min(maxRotationVelocity,rotationVelocity));isInertiaActive=Math.abs(rotationVelocity)>5e-4;setCursor("move")});container.addEventListener("mouseleave",()=>{isDragging=false;setCursor("move")});let initialPinchDistance=0;let isPinching=false;let touchStartTime=0;let totalDragDistance=0;container.addEventListener("touchstart",event=>{event.stopPropagation();if(event.cancelable)event.preventDefault();touchStartTime=Date.now();totalDragDistance=0;autoRotationEnabled=false;userInteracting=true;if(event.touches.length===2){isPinching=true;const touch1=event.touches[0];const touch2=event.touches[1];initialPinchDistance=Math.hypot(touch2.clientX-touch1.clientX,touch2.clientY-touch1.clientY)}else if(event.touches.length===1){isDragging=true;previousMouseX=event.touches[0].clientX;previousMouseY=event.touches[0].clientY;lastDeltaX=0}});container.addEventListener("touchmove",event=>{event.stopPropagation();if(event.cancelable)event.preventDefault();if(isPinching&&event.touches.length===2){const touch1=event.touches[0];const touch2=event.touches[1];const currentPinchDistance=Math.hypot(touch2.clientX-touch1.clientX,touch2.clientY-touch1.clientY);const pinchDelta=currentPinchDistance-initialPinchDistance;const zoomFactor=isMobile?.25:.35;camera.fov-=pinchDelta*zoomFactor;camera.fov=Math.max(10,Math.min(75,camera.fov));camera.updateProjectionMatrix();initialPinchDistance=currentPinchDistance}else if(isDragging&&event.touches.length===1){const deltaX=event.touches[0].clientX-previousMouseX;const deltaY=event.touches[0].clientY-previousMouseY;totalDragDistance+=Math.abs(deltaX)+Math.abs(deltaY);lastDeltaX=deltaX;lon-=deltaX*.1;lat+=deltaY*.1;lat=Math.max(-85,Math.min(85,lat));previousMouseX=event.touches[0].clientX;previousMouseY=event.touches[0].clientY}},{passive:false});container.addEventListener("touchend",event=>{event.stopPropagation();if(event.cancelable)event.preventDefault();userInteracting=false;if(isPinching){isPinching=false;if(event.touches.length===1){isDragging=true;previousMouseX=event.touches[0].clientX;previousMouseY=event.touches[0].clientY}else{isDragging=false}}else if(isDragging){isDragging=false;if(!isPinching){const touchDuration=Date.now()-touchStartTime;const isDeliberateDrag=touchDuration>100&&totalDragDistance>20&&Math.abs(lastDeltaX)>3;if(isDeliberateDrag){const inertiaMult=isMobile?.003:.005;rotationVelocity=-lastDeltaX*inertiaMult;rotationVelocity=Math.max(-maxRotationVelocity,Math.min(maxRotationVelocity,rotationVelocity));isInertiaActive=Math.abs(rotationVelocity)>.005}else{rotationVelocity=0;isInertiaActive=false}}}});container.addEventListener("touchcancel",()=>{userInteracting=false;isDragging=false;isPinching=false});const handleResize=()=>{camera.aspect=container.clientWidth/container.clientHeight;camera.updateProjectionMatrix();renderer.setSize(container.clientWidth,container.clientHeight)};if(typeof ResizeObserver!=="undefined"){const resizeObserver=new ResizeObserver(throttle(handleResize,100));resizeObserver.observe(container)}else{window.addEventListener("resize",throttle(handleResize,100))}function throttle(func,delay){let lastCall=0;return function(...args){const now=Date.now();if(now-lastCall>=delay){lastCall=now;return func.apply(this,args)}}}if(currentDestination){calculateRoute()}}function returnTo360(id=0,isFound=false){document.getElementById("map").style.display="none";document.querySelector(".progress-container").style.display="none";const locationScreen=document.getElementById("locationScreen");locationScreen.classList.add("active");let plaqueId=0;if(id!==0){plaqueId=id}else{plaqueId=userProgress.found.length+1}const currentPlaque=plaques.find(p=>p.id===plaqueId);let locationMask=currentPlaque.locationBlurMaskImage;if(isFound){locationMask=currentPlaque.locationBlurMaskSolvedImage}if(currentPlaque&&currentPlaque.locationImage){document.getElementById("locationTitle").textContent=currentPlaque.locationTitle;document.getElementById("locationDescription").innerHTML=currentPlaque.locationDescription;display360InLocation(currentPlaque,plaqueId,isFound,locationMask)}}function updateStatus(){document.getElementById("counter_progress").innerHTML=userProgress.found.length;document.getElementById("of_counter_progress").innerHTML=plaques.length-1}function setTheme(themeName){if(themeName==="vintage"){document.documentElement.setAttribute("data-theme","vintage")}else if(themeName==="grazia_deledda"){document.documentElement.setAttribute("data-theme","grazia_deledda")}else if(themeName==="may"){document.documentElement.setAttribute("data-theme","may")}else if(themeName==="july"){document.documentElement.setAttribute("data-theme","july")}else if(themeName==="moderno"){document.documentElement.setAttribute("data-theme","moderno")}else{document.documentElement.removeAttribute("data-theme")}localStorage.setItem("selectedTheme",themeName)}document.addEventListener("DOMContentLoaded",async()=>{const gpsIconExists=await checkGpsIconExists();console.log("Icona GPS esiste:",gpsIconExists);if(!gpsIconExists){console.warn("Attenzione: l'icona GPS non Ã¨ stata trovata. VerrÃ  utilizzato un marker predefinito.")}console.log("Inizializzazione dell'app...");if(typeof positionWatchId==="undefined"){window.positionWatchId=null}if(typeof userPosition==="undefined"){window.userPosition=null}document.getElementById("map").style.display="none";document.querySelector(".progress-container").style.display="none"});window.addEventListener("DOMContentLoaded",()=>{setTheme("grazia_deledda");updateStatus();document.addEventListener("DOMContentLoaded",function(){const locationContent=document.querySelector(".location-content");if(locationContent){locationContent.addEventListener("mousedown",function(e){if(!e.target.closest(".location-actions button")){e.preventDefault()}});locationContent.addEventListener("touchstart",function(e){if(!e.target.closest(".location-actions button")){e.preventDefault()}});locationContent.style.userSelect="none";locationContent.style.webkitUserSelect="none";locationContent.style.msUserSelect="none";locationContent.style.mozUserSelect="none";const buttons=locationContent.querySelectorAll(".location-actions button");buttons.forEach(button=>{button.style.pointerEvents="auto"})}});if(isMobile){window.addEventListener("orientationchange",()=>{setTimeout(()=>{if(map&&isMapInitialized){map.invalidateSize()}const locationImage=document.getElementById("locationImage");if(locationImage&&locationImage.scene){const renderer=locationImage.querySelector("canvas");if(renderer){renderer.style.width="100%";renderer.style.height="100%"}}},300)})}});